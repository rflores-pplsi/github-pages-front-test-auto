name: Deploy All Reports to GitHub Pages

on:
  workflow_run:
    workflows:
      - "Header Navigation Suite - Hourly"
      - "LSUS Footer Suite - Hourly"
      - "Small Business Suite - Hourly"
      - "View Contract Suite - Hourly"
      - "LSUS Consumer Flow Suite - Hourly"
    types:
      - completed

concurrency:
  group: github-pages-deployment
  cancel-in-progress: false

jobs:
  deploy-reports:
    name: Deploy Reports to GitHub Pages
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts from completed workflow
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: artifacts
      
      - name: List downloaded artifacts
        run: |
          echo "Downloaded artifacts:"
          ls -la artifacts/ || echo "No artifacts directory"
          find artifacts -type f || echo "No files found"
      
      - name: Checkout gh-pages branch to get existing reports index
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages-content
      
      - name: Prepare deployment
        run: |
          # Find the playwright report
          PLAYWRIGHT_DIR=$(find artifacts -type d -name "playwright-report-*" | head -1)
          CTRF_FILE=$(find artifacts -type f -name "ctrf-report.json" | head -1)
          
          if [ -z "$PLAYWRIGHT_DIR" ]; then
            echo "No Playwright report found, skipping deployment"
            exit 0
          fi
          
          echo "Found Playwright report: $PLAYWRIGHT_DIR"
          
          # Copy playwright report
          mkdir -p playwright-report
          cp -r "$PLAYWRIGHT_DIR"/* playwright-report/ || cp -r "$PLAYWRIGHT_DIR" playwright-report/
          
          # Copy CTRF report if exists
          if [ -n "$CTRF_FILE" ]; then
            mkdir -p ctrf
            cp "$CTRF_FILE" ctrf/ctrf-report.json
          fi
      
      - name: Update reports index
        env:
          GITHUB_RUN_ID: ${{ github.event.workflow_run.id }}
          TEST_SUITE: ${{ github.event.workflow_run.name }}
          GITHUB_REF_NAME: ${{ github.event.workflow_run.head_branch }}
          TEST_STATUS: ${{ github.event.workflow_run.conclusion }}
        run: |
          # Copy existing reports-index.json if it exists
          if [ -f gh-pages-content/reports-index.json ]; then
            cp gh-pages-content/reports-index.json .
            echo "Copied existing reports index"
          else
            echo "No existing reports index found, creating new one"
            echo "[]" > reports-index.json
          fi
          
          # Run the update script
          node scripts/update-reports-index.js
          
          # Prepare deployment directory
          mkdir -p gh-pages-deploy
          cp reports-index.json gh-pages-deploy/
          cp github-pages/index.html gh-pages-deploy/
      
      - name: Deploy Playwright Report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: hashFiles('playwright-report/**') != ''
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./playwright-report
          destination_dir: reports/${{ github.event.workflow_run.id }}
          keep_files: true
      
      - name: Deploy Dashboard to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages-deploy
          keep_files: true
