"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const mocha_1 = __importDefault(require("mocha"));
const scope_1 = require("./scope");
const commander_1 = __importDefault(require("commander"));
const glob_1 = __importDefault(require("glob"));
const path_1 = __importDefault(require("path"));
const hooks_1 = require("./hooks");
const cli_1 = require("./cli");
const config_1 = require("./config");
commander_1.default
    .option('-c, --config <path>', 'path to playwright-mocha config file');
//@ts-ignore
scope_1.TestScope.scope = {};
commander_1.default.parse(process.argv);
const options = commander_1.default.opts();
if (options.config) {
    const configFileContents = config_1.loadConfig(options.config);
    if (configFileContents) {
        scope_1.TestScope.scope.config = configFileContents;
        runMocha();
    }
    else {
        console.log(`Configuration file not found at location ${options.config}`);
        process.exit(1);
    }
}
else {
    cli_1.handleCLI().then(config => {
        scope_1.TestScope.scope.config = config;
        runMocha();
    });
}
function runMocha() {
    const mocha = new mocha_1.default(getMochaOptions());
    const testFiles = glob_1.default.sync('**/*.{js,ts}', { cwd: scope_1.TestScope.scope.config.testFilesBaseDir });
    testFiles.forEach(file => {
        console.log('added new testfile', file);
        mocha.addFile(path_1.default.join(scope_1.TestScope.scope.config.testFilesBaseDir, file));
    });
    mocha.run(failures => process.exitCode = failures ? 1 : 0);
}
function getMochaOptions() {
    if (!scope_1.TestScope.scope.config.mochaOptions) {
        scope_1.TestScope.scope.config.mochaOptions = {};
    }
    scope_1.TestScope.scope.config.mochaOptions.rootHooks = hooks_1.mochaHooks;
    return scope_1.TestScope.scope.config.mochaOptions;
}
